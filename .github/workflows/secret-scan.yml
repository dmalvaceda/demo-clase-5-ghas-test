name: 🔐 Secret Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  trufflehog:
    runs-on: ubuntu-latest
    name: 🕵️ TruffleHog Secret Scanner
    steps:
      - name: 📋 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified=false --json

  gitleaks:
    runs-on: ubuntu-latest
    name: 🔐 GitLeaks Secret Scanner
    steps:
      - name: 📋 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE}}

  detect-secrets:
    runs-on: ubuntu-latest
    name: 🕵️ IBM Detect Secrets
    steps:
      - name: 📋 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 📦 Install detect-secrets
        run: pip install detect-secrets

      - name: 🔍 Run detect-secrets scan
        run: |
          detect-secrets scan --all-files --follow-symlinks \
            --exclude-files '\.git/.*' \
            --exclude-files 'target/.*' \
            --exclude-files '\.github/workflows/.*\.yml' > secrets-baseline.json || true
          
      - name: 📊 Show results
        run: |
          echo "🔍 Secrets detected:"
          cat secrets-baseline.json | python -m json.tool || echo "No secrets found or JSON parsing error"

  semgrep-secrets:
    runs-on: ubuntu-latest
    name: 🛡️ Semgrep Secret Rules
    steps:
      - name: 📋 Checkout code
        uses: actions/checkout@v4

      - name: 🔍 Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/secrets
            p/security-audit
            p/owasp-top-ten
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
